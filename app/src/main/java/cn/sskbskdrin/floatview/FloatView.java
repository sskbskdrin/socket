package cn.sskbskdrin.floatview;

import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.Matrix;
import android.graphics.Point;
import android.graphics.drawable.BitmapDrawable;
import android.os.Build;
import android.os.IBinder;
import android.util.Log;
import android.view.IWindowManager;
import android.view.MotionEvent;
import android.view.View;
import android.view.WindowManager;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

import virtualdisplay.SurfaceControlVirtualDisplayFactory;

public class FloatView extends View {
	private static final String TAG = "FloatView";
	private float mTouchStartX;
	private float mTouchStartY;
	private float x;
	private float y;

	private WindowManager wm = (WindowManager) getContext().getApplicationContext().getSystemService(Context
		.WINDOW_SERVICE);

	private WindowManager.LayoutParams wmParams;

	public FloatView(Context context) {
		super(context);
	}

	public void setWmParams(WindowManager.LayoutParams params) {
		wmParams = params;
	}

	@Override
	public boolean dispatchTouchEvent(MotionEvent event) {
		Log.d(TAG, "dispatchTouchEvent: ");
		return super.dispatchTouchEvent(event);
	}

	@Override
	public boolean onTouchEvent(MotionEvent event) {
//		if(MainActivity.mLayout!=this){
//			MotionEvent temp = MotionEvent.obtain(event);
//			MainActivity.mLayout.dispatchTouchEvent(temp);
//		}
		// 获取相对屏幕的坐标，即以屏幕左上角为原点
		x = event.getRawX();
		y = event.getRawY() - 25; // 25是系统状态栏的高度
		Log.i("currP", "currX" + x + "====currY" + y);
		switch (event.getAction()) {
			case MotionEvent.ACTION_DOWN:

				Class cls = null;
				try {
					cls = Class.forName("android.os.ServiceManager");
					Method getServiceMethod = cls.getDeclaredMethod("getService", new Class[]{String.class});
					final IWindowManager wm = IWindowManager.Stub.asInterface((IBinder) getServiceMethod.invoke(null, new Object[]{"window"}));
					Bitmap bitmap = screenshot(wm);
					Log.d(TAG, "onTouchEvent: bitmap="+bitmap.getWidth());
					setBackground(new BitmapDrawable(bitmap));
				} catch (ClassNotFoundException e) {
					e.printStackTrace();
				} catch (NoSuchMethodException e) {
					e.printStackTrace();
				} catch (IllegalAccessException e) {
					e.printStackTrace();
				} catch (InvocationTargetException e) {
					e.printStackTrace();
				} catch (Exception e) {
					e.printStackTrace();
				}

				mTouchStartX = event.getX();
				mTouchStartY = event.getY();
				Log.i("startP", "startX" + mTouchStartX + "====startY" + mTouchStartY);
				break;
			case MotionEvent.ACTION_MOVE:
				updateViewPosition();
				break;
			case MotionEvent.ACTION_UP:
				updateViewPosition();
				mTouchStartX = mTouchStartY = 0;
				break;
		}
		return false;
	}

	private void updateViewPosition() {
		// 更新浮动窗口位置参数
		wmParams.x = (int) (x - mTouchStartX);
		wmParams.y = (int) (y - mTouchStartY);
		wm.updateViewLayout(this, wmParams);
	}

	public static Bitmap screenshot(IWindowManager wm) throws Exception {
		String surfaceClassName;
		Point size = SurfaceControlVirtualDisplayFactory.getCurrentDisplaySize(false);
		if (Build.VERSION.SDK_INT <= 17) {
			surfaceClassName = "android.view.Surface";
		} else {
			surfaceClassName = "android.view.SurfaceControl";
		}
		Bitmap b = (Bitmap) Class.forName(surfaceClassName).getDeclaredMethod("screenshot", new Class[]{Integer.TYPE, Integer.TYPE}).invoke(null, new Object[]{Integer.valueOf(size.x), Integer.valueOf(size.y)});
		int rotation = wm.getRotation();
		if (rotation == 0) {
			return b;
		}
		Matrix m = new Matrix();
		if (rotation == 1) {
			m.postRotate(-90.0f);
		} else if (rotation == 2) {
			m.postRotate(-180.0f);
		} else if (rotation == 3) {
			m.postRotate(-270.0f);
		}
		return Bitmap.createBitmap(b, 0, 0, size.x, size.y, m, false);
	}

}